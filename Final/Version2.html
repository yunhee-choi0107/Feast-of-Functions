<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Farm Feast — Math Game for 3rd Graders</title>
<style>
  :root{
    --bg:#f7fbf2; --card:#fff; --accent:#6aa84f; --muted:#6b7280;
    --panel:#dff0d8; --danger:#ef4444;
  }
  body{font-family: "Segoe UI", Roboto, Arial; background:var(--bg); margin:0; padding:20px; color:#1f2937;}
  .container{max-width:980px;margin:0 auto;}
  header{display:flex;align-items:center;gap:16px}
  header h1{margin:0;font-size:1.6rem}
  .top-row{display:flex;gap:12px;margin-top:12px;align-items:center;flex-wrap:wrap}
  .scoreboard, .level-panel, .farm-panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(20,20,20,0.06);}
  .scoreboard{flex:1;min-width:220px}
  .level-panel{flex:2;min-width:320px}
  .farm-panel{flex:1;min-width:220px;text-align:center}
  .flex-row{display:flex;gap:12px}
  .big{font-size:1.1rem;font-weight:700}
  .muted{color:var(--muted);font-size:0.9rem}
  .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .small{font-size:0.9rem;padding:6px 8px}
  .question{font-size:1.5rem;margin:14px 0}
  .answer-row{display:flex;gap:8px;align-items:center}
  input[type="number"]{font-size:1.1rem;padding:8px;border-radius:8px;border:1px solid #cbd5e1;width:130px}
  .hint{background:#fff3cd;border:1px solid #ffeeba;padding:8px;border-radius:8px;margin-top:8px;color:#6b4b00}
  .progress{height:12px;background:#e6f2df;border-radius:12px;overflow:hidden;margin-top:8px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#6aa84f,#3b82f6);width:0%}
  .farm-visual{height:180px;border-radius:8px;padding:12px;display:flex;flex-direction:column;justify-content:space-between;align-items:center;background:linear-gradient(180deg,#e6f9e8,#cfeed6);position:relative}
  .farm-row{display:flex;gap:8px}
  .crop{width:48px;height:48px;border-radius:8px;background:linear-gradient(180deg,#fef3c7,#fde68a);display:flex;align-items:center;justify-content:center;font-weight:700;color:#9a3412}
  .crop.grown{background:linear-gradient(180deg,#a7f3d0,#34d399);color:#065f46}
  .status{margin-top:6px;font-weight:600}
  .footer{margin-top:16px;display:flex;gap:8px;flex-wrap:wrap}
  .mini-panel{padding:10px;border-radius:10px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
  .feast{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
  .feast .dialog{background:white;padding:20px;border-radius:12px;text-align:center;max-width:600px}
  .food-list{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
  .food{background:linear-gradient(180deg,#ffedd5,#fecaca);padding:8px;border-radius:8px;min-width:64px}
  .feedback{margin-top:8px;height:22px}
  .green{color:#0b6b2d;font-weight:700}
  .red{color:var(--danger);font-weight:700}
  .dashed{border:2px dashed #c7d2fe;padding:8px;border-radius:8px}
  @media (max-width:900px){ .top-row{flex-direction:column} .flex-row{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
  <header>
    <img alt="logo" src="" style="width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,#bde0a8,#6aa84f);display:block">
    <div>
      <h1>Farm Feast — Help the farmer with math!</h1>
      <div class="muted">Three levels: Sowing (Add/Sub), Growing (×), Harvest (÷). Pass all levels to unlock the feast.</div>
    </div>
  </header>

  <div class="top-row" style="margin-top:14px">
    <div class="scoreboard mini-panel">
      <div class="big">Progress & Score</div>
      <div style="margin-top:8px">
        <div>Level status: <span id="status-level">Level 1 - Sowing</span></div>
        <div style="margin-top:6px">Level passes: <span id="passed-count">0</span> / 3</div>
      </div>
      <div style="margin-top:10px">
        <div>Food collected: <strong id="food-count">0</strong></div>
        <div class="progress"><i id="food-bar" style="width:0%"></i></div>
      </div>
      <div style="margin-top:10px" class="muted">Hints used: <span id="hints-used">0</span></div>
    </div>

    <div class="level-panel mini-panel">
      <div class="big" id="level-title">Level 1 — Sowing (Addition & Subtraction)</div>
      <div class="muted" id="level-desc">Help sow seeds by answering addition and subtraction questions.</div>

      <div style="margin-top:10px" class="question" id="question">Loading …</div>

      <div class="answer-row">
        <input id="answer" type="number" placeholder="Your answer" />
        <button class="btn" id="submitBtn">Submit</button>
        <button class="small" id="hintBtn">AI Helper (Hint)</button>
        <button class="small" id="skipBtn">Skip</button>
      </div>
      <div class="feedback" id="feedback"></div>
      <div id="hintBox" class="hint" style="display:none"></div>

      <div style="margin-top:12px" class="muted">Attempts for this question: <span id="attempts">0</span></div>

      <div style="margin-top:12px">
        <div style="display:flex;gap:8px">
          <button class="small" id="nextQBtn" disabled>Next Problem</button>
          <button class="small" id="openWorkbookBtn">Open Workbook (for help)</button>
          <button class="small" id="openBonusBtn">Play Bonus Game</button>
        </div>
      </div>
    </div>

    <div class="farm-panel mini-panel">
      <div class="big">Farmer's Field</div>
      <div class="farm-visual" id="farmVisual">
        <div class="muted">Farm scene</div>
        <div class="farm-row" id="cropsRow">
          <!-- crops -->
        </div>
        <div class="status" id="farmStatus">Stage: Sowing</div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="mini-panel dashed" style="flex:1">
      <div style="font-weight:700">How it works (simple)</div>
      <ol style="padding-left:16px;margin:6px 0">
        <li>Solve problems → correct answers move the farmer's task forward.</li>
        <li>If you get stuck: AI Helper gives hints or open the Workbook mini-challenge.</li>
        <li>Play the Bonus mini-game anytime to earn extra food for the final feast.</li>
      </ol>
    </div>

    <div class="mini-panel" style="width:260px">
      <div style="font-weight:700">Level passes</div>
      <div style="margin-top:8px">
        <div>Level 1: <span id="pass1">Not passed</span></div>
        <div>Level 2: <span id="pass2">Not passed</span></div>
        <div>Level 3: <span id="pass3">Not passed</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Workbook modal -->
<div id="workbookModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center">
  <div style="background:white;padding:18px;border-radius:12px;max-width:520px;margin:auto">
    <h3>Workbook — Guided practice</h3>
    <div class="muted">These are easier step-by-step problems to help you build confidence.</div>
    <div style="margin-top:8px" id="wb-question">...</div>
    <div style="margin-top:8px" class="answer-row">
      <input id="wb-answer" type="number" placeholder="Answer" />
      <button class="btn small" id="wb-submit">Submit</button>
      <button class="small" id="wb-close">Close</button>
    </div>
    <div id="wb-feedback" style="margin-top:8px"></div>
  </div>
</div>

<!-- Bonus mini-game modal -->
<div id="bonusModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center">
  <div style="background:white;padding:18px;border-radius:12px;max-width:520px;margin:auto">
    <h3>Bonus Game — Catch the falling fruits!</h3>
    <div class="muted">Click fruits as they appear to earn extra food for the feast. You have 20 seconds.</div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <button class="btn small" id="startBonus">Start 20s</button>
      <div id="bonusTimer" class="muted">Ready</div>
      <div style="margin-left:auto">Score: <span id="bonusScore">0</span></div>
    </div>
    <div id="bonusArea" style="height:220px;border-radius:8px;background:#f6fffb;margin-top:10px;position:relative;overflow:hidden"></div>
    <div style="margin-top:10px">
      <button class="small" id="bonusClose">Close</button>
    </div>
  </div>
</div>

<!-- Feast dialog -->
<div class="feast" id="feastDialog">
  <div class="dialog">
    <h2>Feast Time! 🎉</h2>
    <div id="feastText">The farmer prepared a feast with the food you helped grow!</div>
    <div class="food-list" id="feastFoods"></div>
    <div style="margin-top:12px"><button class="btn" id="closeFeast">Close</button></div>
  </div>
</div>

<script>
/* ======= Game logic ======= */
const state = {
  level: 1, // 1,2,3
  passes: [false,false,false],
  food: 0,
  hintsUsed: 0,
  attempts: 0,
  currentQ: null,
  difficulty: {1:1,2:1,3:1}, // scales with success
  cropsProgress: {1:0,2:0,3:0}, // each level needs 5 correct to pass
};

const LEVEL_CONFIG = {
  1: {name:'Sowing', desc:'Addition & Subtraction', func: genAddSub},
  2: {name:'Growing', desc:'Multiplication', func: genMultiply},
  3: {name:'Harvesting', desc:'Division', func: genDivision}
};

const TARGET_PER_LEVEL = 5; // number of correct answers to pass a level

/* ======= UI references ======= */
const qEl = document.getElementById('question');
const ansEl = document.getElementById('answer');
const submitBtn = document.getElementById('submitBtn');
const feedbackEl = document.getElementById('feedback');
const hintBtn = document.getElementById('hintBtn');
const hintBox = document.getElementById('hintBox');
const attemptsEl = document.getElementById('attempts');
const nextQBtn = document.getElementById('nextQBtn');
const statusLevel = document.getElementById('status-level');
const levelTitle = document.getElementById('level-title');
const levelDesc = document.getElementById('level-desc');
const farmStatus = document.getElementById('farmStatus');
const cropsRow = document.getElementById('cropsRow');
const foodCount = document.getElementById('food-count');
const foodBar = document.getElementById('food-bar');
const passedCount = document.getElementById('passed-count');
const pass1 = document.getElementById('pass1'), pass2 = document.getElementById('pass2'), pass3 = document.getElementById('pass3');
const openWorkbookBtn = document.getElementById('openWorkbookBtn');
const workbookModal = document.getElementById('workbookModal');
const wbQuestion = document.getElementById('wb-question');
const wbAnswer = document.getElementById('wb-answer');
const wbSubmit = document.getElementById('wb-submit');
const wbClose = document.getElementById('wb-close');
const wbFeedback = document.getElementById('wb-feedback');
const hintsUsedEl = document.getElementById('hints-used');
const openBonusBtn = document.getElementById('openBonusBtn');
const bonusModal = document.getElementById('bonusModal');
const bonusArea = document.getElementById('bonusArea');
const startBonus = document.getElementById('startBonus');
const bonusTimer = document.getElementById('bonusTimer');
const bonusScoreEl = document.getElementById('bonusScore');
const bonusClose = document.getElementById('bonusClose');
const bonusScoreState = {score:0, running:false, timer: null};
const feastDialog = document.getElementById('feastDialog');
const feastFoods = document.getElementById('feastFoods');
const closeFeast = document.getElementById('closeFeast');

function init() {
  updateLevelUI();
  newQuestion();
  renderCrops();
  attachEvents();
}
function attachEvents(){
  submitBtn.addEventListener('click', onSubmit);
  ansEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSubmit()});
  hintBtn.addEventListener('click', giveHint);
  nextQBtn.addEventListener('click', ()=>{ newQuestion(); });
  openWorkbookBtn.addEventListener('click', ()=> workbookModal.style.display='flex');
  wbClose.addEventListener('click', ()=> workbookModal.style.display='none');
  wbSubmit.addEventListener('click', checkWorkbook);
  openBonusBtn.addEventListener('click', ()=> bonusModal.style.display='flex');
  startBonus.addEventListener('click', startBonusGame);
  bonusClose.addEventListener('click', ()=> { stopBonus(); bonusModal.style.display='none'; });
  closeFeast.addEventListener('click', ()=> feastDialog.style.display='none');
}

/* ======= Question generation functions ======= */
function genAddSub(diff=1){
  // diff affects size of numbers
  const max = 10 + diff*6;
  const a = rnd(1,max), b = rnd(1,max);
  const op = Math.random() < 0.5 ? '+' : '-';
  const q = `${a} ${op} ${b}`;
  const ans = op === '+' ? a+b : a-b;
  return {text:q, answer:ans, hint:`Try breaking numbers apart. Example: ${a} ${op} ${b}`};
}
function genMultiply(diff=1){
  const max = 4 + diff*3; // keep manageable
  const a = rnd(2,max), b = rnd(2,max);
  return {text: `${a} × ${b}`, answer: a*b, hint: `Multiplication is repeated addition: ${a} added ${b} times.`};
}
function genDivision(diff=1){
  // produce integer divisions mostly
  const max = 6 + diff*3;
  const b = rnd(2,max);
  const ans = rnd(2,max);
  const a = b * ans;
  return {text: `${a} ÷ ${b}`, answer: ans, hint: `What number multiplied by ${b} gives ${a}?`};
}

/* ======= Helpers ======= */
function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function updateLevelUI(){
  const cfg = LEVEL_CONFIG[state.level];
  levelTitle.textContent = `Level ${state.level} — ${cfg.name} (${cfg.desc})`;
  levelDesc.textContent = `Help ${cfg.name.toLowerCase()} by answering ${cfg.desc.toLowerCase()} problems.`;
  statusLevel.textContent = `Level ${state.level} - ${cfg.name}`;
  farmStatus.textContent = `Stage: ${cfg.name}`;
}
function newQuestion(){
  hintBox.style.display='none'; feedbackEl.textContent=''; attemptsEl.textContent='0'; state.attempts=0; ansEl.value='';
  const gen = LEVEL_CONFIG[state.level].func;
  const q = gen(state.difficulty[state.level] || 1);
  state.currentQ = q;
  qEl.textContent = q.text;
  nextQBtn.disabled = true;
}
function onSubmit(){
  const raw = ansEl.value;
  if(raw===''){ feedback('Please enter an answer.', 'red'); return; }
  const num = Number(raw);
  state.attempts++;
  attemptsEl.textContent = state.attempts;
  if(num === state.currentQ.answer){
    feedback('Correct! ⭐', 'green');
    handleCorrect();
  } else {
    feedback('Not quite — try again or use a hint.', 'red');
    handleIncorrect();
  }
}
function feedback(msg, type){
  feedbackEl.textContent = msg;
  feedbackEl.className = type==='green' || type==='green' ? '' : '';
  feedbackEl.innerHTML = (type==='green') ? `<span class="green">${msg}</span>` : `<span class="red">${msg}</span>`;
}

/* ======= Correct / Incorrect handling ======= */
function handleCorrect(){
  // progress farming
  state.cropsProgress[state.level] = Math.min(TARGET_PER_LEVEL, state.cropsProgress[state.level] + 1);
  // reward food
  state.food += 2; // reward for correct
  updateFoodUI();
  renderCrops();

  // increase difficulty slowly if many successes
  state.difficulty[state.level] = Math.min(4, state.difficulty[state.level] + 0.1);

  // mark pass if reached target
  if(state.cropsProgress[state.level] >= TARGET_PER_LEVEL){
    passLevel(state.level);
  } else {
    nextQBtn.disabled = false;
    // auto load next after a short delay
    setTimeout(()=>{ newQuestion(); }, 900);
  }
}

function handleIncorrect(){
  // give the player chance to retry; after 2 attempts, suggest workbook
  if(state.attempts >= 2){
    // nudge to workbook
    wbSuggestion();
  }
  // small penalty: hints recommended (no food loss for kid-friendly)
}

/* ======= Hint / AI Helper ======= */
function giveHint(){
  state.hintsUsed++;
  hintsUsedEl.textContent = state.hintsUsed;
  const hint = state.currentQ.hint || "Try to break the problem into smaller pieces.";
  hintBox.style.display='block';
  hintBox.textContent = `AI Helper hint: ${hint}`;
}

/* ======= Workbook mini challenge (help for struggling players) ======= */
function wbSuggestion(){
  wbFeedback.textContent = 'It looks like you are struggling. Try a step-by-step problem in the Workbook.';
  workbookModal.style.display='flex';
  createWorkbookQuestion();
}
function createWorkbookQuestion(){
  // produce an easier / guided variant of the current topic
  let q;
  if(state.level === 1){
    // smaller numbers, step hint
    const a = rnd(1,6), b = rnd(1,6);
    q = {text: `${a} + ${b}`, answer: a+b, hint: `Add ${a} and ${b} together.`};
  } else if(state.level === 2){
    const a = rnd(2,4), b = rnd(2,3);
    q = {text: `${a} × ${b}`, answer: a*b, hint: `Multiply: ${a} groups of ${b}.`};
  } else {
    const b = rnd(2,4), ans = rnd(2,4);
    const a = b*ans;
    q = {text: `${a} ÷ ${b}`, answer: ans, hint: `What times ${b} equals ${a}?`};
  }
  workbookModal.dataset.q = JSON.stringify(q);
  wbQuestion.textContent = q.text;
  wbFeedback.textContent = '';
  wbAnswer.value = '';
}

function checkWorkbook(){
  try{
    const q = JSON.parse(workbookModal.dataset.q);
    if(Number(wbAnswer.value) === q.answer){
      wbFeedback.innerHTML = `<span class="green">Good job! You solved it.</span>`;
      state.food += 1; updateFoodUI();
      // small boost in confidence: lower difficulty slightly
      state.difficulty[state.level] = Math.max(1, state.difficulty[state.level]-0.2);
      setTimeout(()=>{ workbookModal.style.display='none'; newQuestion(); }, 700);
    } else {
      wbFeedback.innerHTML = `<span class="red">Not yet — hint: ${q.hint}</span>`;
    }
  } catch(e){ console.error(e) }
}

/* ======= Passing levels ======= */
function passLevel(lvl){
  state.passes[lvl-1] = true;
  document.getElementById('pass' + lvl).textContent = 'Passed';
  passedCount.textContent = state.passes.filter(Boolean).length;
  feedback(`You passed Level ${lvl}!`, 'green');

  // reward big food and unlock next level
  state.food += 5;
  updateFoodUI();

  // auto-move to next level if exists
  if(lvl < 3){
    state.level++;
    updateLevelUI();
    renderCrops();
    newQuestion();
  } else {
    // all passed => show feast
    checkFeast();
  }
}

/* ======= Farm visuals ======= */
function renderCrops(){
  cropsRow.innerHTML='';
  for(let L=1; L<=3; L++){
    const prog = state.cropsProgress[L];
    const card = document.createElement('div');
    card.style.textAlign='center';
    card.style.width='86px';
    card.innerHTML = `<div style="font-weight:700">Level ${L}</div>
      <div style="display:flex;gap:6px;justify-content:center;margin-top:6px">
        ${Array.from({length:TARGET_PER_LEVEL}).map((_,i)=> `<div class="crop ${i<prog? 'grown':''}">${i<prog? '🍎':'🌱'}</div>`).join('')}
      </div>
      <div style="font-size:0.85rem;margin-top:6px">${LEVEL_CONFIG[L].name}</div>`;
    cropsRow.appendChild(card);
  }
}

/* ======= Food UI ======= */
function updateFoodUI(){
  foodCount.textContent = state.food;
  const percent = Math.min(100, state.food * 6); // arbitrary scale
  foodBar.style.width = percent + '%';
}

/* ======= Bonus mini-game: catch fruits ======= */
let bonusInterval = null;
function startBonusGame(){
  if(bonusScoreState.running) return;
  bonusScoreState.running = true;
  bonusScoreState.score = 0; bonusScoreEl.textContent = 0;
  bonusTimer.textContent = '20s';
  bonusArea.innerHTML = '';
  startBonus.disabled = true;

  let timeLeft = 20;
  bonusInterval = setInterval(()=>{
    timeLeft--;
    bonusTimer.textContent = `${timeLeft}s`;
    spawnFruit();
    if(timeLeft <= 0){ stopBonus(); finalizeBonus(); }
  }, 1000);
}
function spawnFruit(){
  const fruit = document.createElement('div');
  fruit.textContent = '🍓';
  fruit.style.position='absolute';
  fruit.style.fontSize='26px';
  fruit.style.cursor='pointer';
  const x = rnd(8,bonusArea.clientWidth-36);
  fruit.style.left = x + 'px';
  fruit.style.top = (rnd(10,bonusArea.clientHeight-36)) + 'px';
  fruit.addEventListener('click', ()=> {
    bonusScoreState.score++;
    bonusScoreEl.textContent = bonusScoreState.score;
    fruit.remove();
  });
  bonusArea.appendChild(fruit);
  // remove after 2.5s
  setTimeout(()=> fruit.remove(), 2500);
}
function stopBonus(){
  bonusScoreState.running = false;
  clearInterval(bonusInterval);
  startBonus.disabled = false;
  bonusTimer.textContent = 'Stopped';
}
function finalizeBonus(){
  // convert score to food
  const gained = bonusScoreState.score;
  state.food += gained;
  updateFoodUI();
  alert(`Bonus ended — you earned ${gained} extra food!`);
}

/* ======= Feast check ======= */
function checkFeast(){
  if(state.passes.every(Boolean)){
    // open feast
    feastFoods.innerHTML = '';
    const foods = ['Bread','Soup','Fruit','Vegetables','Pie','Cheese','Juice'];
    // Use food count to show how many are served
    const itemsToShow = Math.min(foods.length, Math.max(3, Math.floor(state.food/3)));
    for(let i=0;i<itemsToShow;i++){
      const f = document.createElement('div');
      f.className='food';
      f.textContent = foods[i];
      feastFoods.appendChild(f);
    }
    feastDialog.style.display='flex';
  }
}

/* ======= Utility functions ======= */
function rndChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ======= Start game ======= */
init();

/* ======= Extras: allow skipping question and skipping penalties ======= */
document.getElementById('skipBtn').addEventListener('click', ()=>{
  // Skipping gives a small hint and a minor food penalty to encourage attempts
  state.food = Math.max(0, state.food - 1);
  updateFoodUI();
  feedback('Question skipped. Try the next one!', 'red');
  newQuestion();
});

/* ======= Next question button enables when correct or after a short time ======= */
nextQBtn.addEventListener('click', ()=> newQuestion());

/* ======= Simple UI to view total passes on load ======= */
(function refreshPassCount(){ passedCount.textContent = state.passes.filter(Boolean).length; })();
</script>
</body>
</html>
